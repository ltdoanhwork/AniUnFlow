/home/serverai/ltdoanh/AniUnFlow/models/aniunflow/model.py:53: FutureWarning: `torch.cuda.amp.autocast(args...)` is deprecated. Please use `torch.amp.autocast('cuda', args...)` instead.
  @torch.cuda.amp.autocast(enabled=True)
/home/serverai/ltdoanh/AniUnFlow/engine/trainer_segment_aware.py:207: FutureWarning: `torch.cuda.amp.GradScaler(args...)` is deprecated. Please use `torch.amp.GradScaler('cuda', args...)` instead.
  self.scaler = torch.cuda.amp.GradScaler(enabled=torch.cuda.is_available())
=== Debug V4 Training Loop ===
Initializing Trainer...
[Trainer] Initializing AniFlowFormerTV4...
[AniFlowFormerTV4] Warning: 'sam2' module not found. Disabling SAM encoder features.
Creating DataLoader...
[Dataset] Using 'original' subdir for SAM mask alignment
[Train] Found 20 sequences under data/AnimeRun_v2/train/Frame_Anime

Running 1 training step...
Epoch 0:   0%|          | 0/2 [00:00<?, ?it/s]Epoch 0:   0%|          | 0/2 [00:02<?, ?it/s]
Traceback (most recent call last):
  File "/home/serverai/ltdoanh/AniUnFlow/scripts/debug_v4_train.py", line 85, in <module>
    main()
    ~~~~^^
  File "/home/serverai/ltdoanh/AniUnFlow/scripts/debug_v4_train.py", line 79, in main
    accum = trainer._train_one_epoch(loader)
  File "/home/serverai/ltdoanh/AniUnFlow/engine/trainer_segment_aware.py", line 434, in _train_one_epoch
    out_fw = self.model(
        clip,
    ...<2 lines>...
        return_losses=True
    )
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1775, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1786, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/serverai/ltdoanh/AniUnFlow/models/aniunflow_v4/model.py", line 338, in forward
    flows_fw, bn_fw = self._get_flows(clip, sam_masks, sam_features)
                      ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/serverai/ltdoanh/AniUnFlow/models/aniunflow_v4/model.py", line 249, in _get_flows
    latent = self.lcm(tokens)
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1775, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1786, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/serverai/ltdoanh/AniUnFlow/models/aniunflow/lcm.py", line 34, in forward
    x = blk(x)
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1775, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1786, in _call_impl
    return forward_call(*args, **kwargs)
  File "/home/serverai/ltdoanh/AniUnFlow/models/aniunflow/lcm.py", line 18, in forward
    return x + self.mlp(self.n2(x))
               ~~~~~~~~^^^^^^^^^^^^
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1775, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1786, in _call_impl
    return forward_call(*args, **kwargs)
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/container.py", line 250, in forward
    input = module(input)
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1775, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/module.py", line 1786, in _call_impl
    return forward_call(*args, **kwargs)
  File "/srv/conda/envs/serverai/opf/lib/python3.14/site-packages/torch/nn/modules/linear.py", line 134, in forward
    return F.linear(input, self.weight, self.bias)
           ~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 18.00 MiB. GPU 0 has a total capacity of 79.25 GiB of which 13.62 MiB is free. Process 319302 has 21.61 GiB memory in use. Process 2311632 has 14.12 GiB memory in use. Process 3459190 has 622.00 MiB memory in use. Process 3483893 has 31.10 GiB memory in use. Including non-PyTorch memory, this process has 11.75 GiB memory in use. Of the allocated memory 11.18 GiB is allocated by PyTorch, and 79.87 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
